# vJass è§£æå™¨ Code Review æŠ¥å‘Š

## å®¡æŸ¥æ—¥æœŸ
2024å¹´

## å®¡æŸ¥èŒƒå›´
å¯¹ç…§ `static/vjass.docs.txt` æ–‡æ¡£ï¼Œæ£€æŸ¥ `src/vjass/parser.ts` çš„å®ç°å®Œæ•´æ€§

---

## âœ… å·²æ­£ç¡®å®ç°çš„åŠŸèƒ½

### 1. Struct è§£æ (parseStruct)
- âœ… åŸºæœ¬ç»“æ„å£°æ˜ï¼š`struct name ... endstruct`
- âœ… ç»§æ‰¿è¯­æ³•ï¼š`struct B extends A`
- âœ… æ•°ç»„ç»“æ„ï¼š`struct X extends array [20000]`
- âœ… ç´¢å¼•ç©ºé—´å¢å¼ºï¼š`struct X[10000]`
- âœ… æˆå‘˜å˜é‡å£°æ˜ï¼ˆæ”¯æŒ private/public/readonly/staticï¼‰
- âœ… æ–¹æ³•å£°æ˜ï¼ˆæ”¯æŒ public/private/static/stub/operatorï¼‰
- âœ… delegate å£°æ˜
- âœ… implement è¯­å¥ï¼ˆæ¨¡å—å®ç°ï¼‰
- âœ… éªŒè¯ï¼šä¸èƒ½åœ¨ç»§æ‰¿çš„ç»“æ„ä¸Šä½¿ç”¨ç´¢å¼•ç©ºé—´å¢å¼º

### 2. Interface è§£æ (parseInterface)
- âœ… åŸºæœ¬æ¥å£å£°æ˜ï¼š`interface name ... endinterface`
- âœ… æ–¹æ³•å£°æ˜ï¼ˆæ¥å£ä¸­ä¸å…è®¸ stub/privateï¼‰
- âœ… defaults å…³é”®å­—æ”¯æŒï¼ˆåœ¨ parseMethod ä¸­å¤„ç†ï¼‰
- âœ… é”™è¯¯æ£€æŸ¥ï¼šæ¥å£ä¸­ä¸å…è®¸ private method
- âœ… é”™è¯¯æ£€æŸ¥ï¼šæ¥å£ä¸­ä¸å…è®¸ stub method

### 3. Method è§£æ (parseMethod)
- âœ… åŸºæœ¬æ–¹æ³•å£°æ˜ï¼š`method name takes ... returns ...`
- âœ… static æ–¹æ³•ï¼š`static method ...`
- âœ… stub æ–¹æ³•ï¼š`stub method ...`
- âœ… operator é‡è½½ï¼š`method operator [] ...`ã€`method operator < ...` ç­‰
- âœ… defaults å…³é”®å­—ï¼ˆç”¨äºæ¥å£æ–¹æ³•ï¼‰
- âœ… æ–¹æ³•ä½“è§£æï¼ˆstruct ä¸­éœ€è¦ bodyï¼Œinterface ä¸­ä¸éœ€è¦ï¼‰
- âœ… é”™è¯¯æ£€æŸ¥ï¼šonDestroy ä¸èƒ½æ˜¯ private

### 4. Library å’Œ Scope è§£æ
- âœ… library å£°æ˜ï¼š`library name ... endlibrary`
- âœ… scope å£°æ˜ï¼š`scope name ... endscope`
- âœ… requires/needs/uses ä¾èµ–å…³ç³»
- âœ… initializer åˆå§‹åŒ–å‡½æ•°
- âœ… private/public æˆå‘˜æ”¯æŒ

---

## âš ï¸ æ½œåœ¨é—®é¢˜å’Œæ”¹è¿›å»ºè®®

### 1. Method è§£æä¸­çš„ public/private å¤„ç†

**é—®é¢˜ä½ç½®**ï¼š`src/vjass/parser.ts:1442-1488`

**é—®é¢˜æè¿°**ï¼š
- åœ¨ `parseStruct` ä¸­å¤„ç† `public method` å’Œ `private method` æ—¶ï¼Œå¦‚æœé‡åˆ° `public static method` æˆ– `private static method`ï¼Œä¼šå…ˆæ¶ˆè´¹ `public`/`private` å’Œ `static`ï¼Œç„¶åæ£€æŸ¥æ˜¯å¦æ˜¯ `method`
- å¦‚æœæ£€æŸ¥å¤±è´¥ï¼ˆpeekToken2 ä¸æ˜¯ methodï¼‰ï¼Œå·²ç»æ¶ˆè´¹çš„ token æ— æ³•å›é€€ï¼Œå¯èƒ½å¯¼è‡´åç»­è§£æé”™è¯¯

**å»ºè®®**ï¼š
```typescript
// å½“å‰ä»£ç åœ¨ 1466-1467 è¡Œå’Œ 1485-1486 è¡Œæœ‰æ³¨é‡Šè¯´æ˜è¿™ä¸ªé—®é¢˜
// å»ºè®®ï¼šåœ¨ç¡®è®¤æ˜¯ method ä¹‹å‰ä¸è¦æ¶ˆè´¹ static
// æˆ–è€…ï¼šä½¿ç”¨æ›´æ™ºèƒ½çš„ lookahead æœºåˆ¶
```

### 2. Interface æ‰©å±•æ”¯æŒ

**é—®é¢˜ä½ç½®**ï¼š`src/vjass/parser.ts:1811-1821`

**é—®é¢˜æè¿°**ï¼š
- ä»£ç ä¸­æ£€æŸ¥äº† `extends` å…³é”®å­—ï¼Œä½†åªæ˜¯æ¶ˆè´¹äº† tokenï¼Œæ²¡æœ‰å®é™…å¤„ç†æ¥å£æ‰©å±•
- æ ¹æ®æ–‡æ¡£ï¼ŒvJass å¯èƒ½ä¸æ”¯æŒæ¥å£ç»§æ‰¿ï¼Œä½†ä»£ç é¢„ç•™äº†ä½ç½®

**å»ºè®®**ï¼š
- å¦‚æœ vJass ä¸æ”¯æŒæ¥å£ç»§æ‰¿ï¼Œåº”è¯¥æŠ¥é”™è€Œä¸æ˜¯é™é»˜å¿½ç•¥
- å¦‚æœæ”¯æŒï¼Œéœ€è¦å®Œæ•´å®ç°æ¥å£ç»§æ‰¿é€»è¾‘

### 3. MethodDeclaration ç¼ºå°‘ isPublic/isPrivate å±æ€§

**é—®é¢˜ä½ç½®**ï¼š`src/vjass/parser.ts:1443-1444` æ³¨é‡Š

**é—®é¢˜æè¿°**ï¼š
- ä»£ç æ³¨é‡Šä¸­æåˆ°ï¼š"å¦‚æœéœ€è¦æ”¯æŒ private/publicï¼Œåº”è¯¥åœ¨ MethodDeclaration ä¸­æ·»åŠ  isPrivate/isPublic å±æ€§"
- ä½†å®é™…ä¸Š `MethodDeclaration` AST èŠ‚ç‚¹ä¸­æ²¡æœ‰è¿™äº›å±æ€§
- è¿™æ„å‘³ç€ public/private ä¿¡æ¯åœ¨è§£ææ—¶ä¸¢å¤±äº†

**å»ºè®®**ï¼š
- åœ¨ `MethodDeclaration` AST èŠ‚ç‚¹ä¸­æ·»åŠ  `isPublic` å’Œ `isPrivate` å±æ€§
- åœ¨ `parseStruct` ä¸­è®¾ç½®è¿™äº›å±æ€§

### 4. æ•°ç»„æˆå‘˜è§£æ

**é—®é¢˜ä½ç½®**ï¼šéœ€è¦æ£€æŸ¥ `parseVariableDeclaration`

**é—®é¢˜æè¿°**ï¼š
- æ–‡æ¡£ä¸­æåˆ°ç»“æ„å¯ä»¥å£°æ˜æ•°ç»„æˆå‘˜ï¼š`integer array V[100]`
- éœ€è¦ç¡®è®¤ `parseVariableDeclaration` æ˜¯å¦æ­£ç¡®å¤„ç†äº†æ•°ç»„å¤§å°è¯­æ³•

**å»ºè®®**ï¼š
- æ£€æŸ¥ `parseVariableDeclaration` æ˜¯å¦æ­£ç¡®è§£æäº† `[size]` è¯­æ³•
- ç¡®è®¤æ•°ç»„æˆå‘˜çš„å¤§å°é™åˆ¶æ£€æŸ¥

### 5. Static if è¯­å¥

**é—®é¢˜ä½ç½®**ï¼šéœ€è¦æ£€æŸ¥ `parseStatement`

**é—®é¢˜æè¿°**ï¼š
- æ–‡æ¡£ä¸­æåˆ° `static if` è¯­å¥ï¼Œéœ€è¦ç¡®è®¤æ˜¯å¦æ­£ç¡®å®ç°
- static if çš„æ¡ä»¶å¿…é¡»æ˜¯ç¼–è¯‘æ—¶å¸¸é‡

**å»ºè®®**ï¼š
- æ£€æŸ¥ static if çš„è§£æå’ŒéªŒè¯é€»è¾‘

### 6. é”™è¯¯æ¢å¤æœºåˆ¶

**é—®é¢˜ä½ç½®**ï¼š`src/vjass/parser.ts:1738` çš„ `synchronize()` è°ƒç”¨

**é—®é¢˜æè¿°**ï¼š
- å½“é‡åˆ°è¯­æ³•é”™è¯¯æ—¶ï¼Œä½¿ç”¨ `synchronize()` è¿›è¡Œé”™è¯¯æ¢å¤
- éœ€è¦ç¡®è®¤åŒæ­¥ç‚¹æ˜¯å¦è¶³å¤Ÿï¼Œæ˜¯å¦èƒ½æ­£ç¡®æ¢å¤

**å»ºè®®**ï¼š
- æ£€æŸ¥ `synchronize()` æ–¹æ³•çš„å®ç°
- ç¡®ä¿åœ¨ struct/interface/library/scope ç­‰å—ç»“æ„ä¸­èƒ½æ­£ç¡®åŒæ­¥

---

## ğŸ“‹ å¾…éªŒè¯çš„åŠŸèƒ½

### 1. é«˜çº§ç‰¹æ€§
- [ ] Module è§£æï¼ˆ`module ... endmodule`ï¼‰
- [ ] Hook è¯­å¥ï¼ˆ`hook FunctionName HookFunction`ï¼‰
- [ ] Inject è¯­å¥ï¼ˆ`//! inject main ... //! endinject`ï¼‰
- [ ] LoadData è¯­å¥ï¼ˆ`//! loaddata "path.slk"`ï¼‰
- [ ] TextMacro è§£æï¼ˆ`//! textmacro ... //! endtextmacro`ï¼‰
- [ ] RunTextMacro è§£æï¼ˆ`//! runtextmacro ...`ï¼‰

### 2. ç±»å‹å£°æ˜
- [ ] Type å£°æ˜ï¼ˆ`type name extends type array [size]`ï¼‰
- [ ] åŠ¨æ€æ•°ç»„ç±»å‹å£°æ˜

### 3. è¡¨è¾¾å¼å’Œè¯­å¥
- [ ] Super è¡¨è¾¾å¼ï¼ˆ`super.method()`ï¼‰
- [ ] Thistype è¡¨è¾¾å¼ï¼ˆ`thistype.allocate()`ï¼‰
- [ ] Typecast è¡¨è¾¾å¼ï¼ˆ`TypeName(value)`ï¼‰

---

## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥

### 1. é”™è¯¯å¤„ç†
- âœ… å¤§éƒ¨åˆ†åœ°æ–¹éƒ½æœ‰é”™è¯¯æ£€æŸ¥
- âœ… é”™è¯¯æ¶ˆæ¯æ¸…æ™°ï¼ŒåŒ…å«ä½ç½®ä¿¡æ¯
- âš ï¸ æŸäº›åœ°æ–¹æ¶ˆè´¹ token åæ— æ³•å›é€€ï¼ˆå¦‚ public static method çš„æƒ…å†µï¼‰

### 2. ä»£ç é‡å¤
- âš ï¸ `parseStruct` å’Œ `parseInterface` ä¸­æœ‰ä¸€äº›é‡å¤çš„æˆå‘˜è§£æé€»è¾‘
- å»ºè®®ï¼šæå–å…¬å…±çš„æˆå‘˜è§£æé€»è¾‘

### 3. æ³¨é‡Šè´¨é‡
- âœ… å…³é”®ä½ç½®éƒ½æœ‰æ³¨é‡Šè¯´æ˜
- âœ… å¤æ‚é€»è¾‘æœ‰è¯¦ç»†æ³¨é‡Š
- âš ï¸ æŸäº› TODO å’Œ FIXME éœ€è¦å¤„ç†

### 4. ç±»å‹å®‰å…¨
- âœ… ä½¿ç”¨äº† TypeScript ç±»å‹ç³»ç»Ÿ
- âœ… AST èŠ‚ç‚¹ç±»å‹å®šä¹‰æ¸…æ™°
- âš ï¸ æŸäº›åœ°æ–¹ä½¿ç”¨äº† `any` æˆ–ç±»å‹æ–­è¨€ï¼Œéœ€è¦æ£€æŸ¥

---

## ğŸ¯ ä¼˜å…ˆçº§ä¿®å¤å»ºè®®

### é«˜ä¼˜å…ˆçº§
1. **ä¿®å¤ public/private static method çš„ token æ¶ˆè´¹é—®é¢˜**
   - åœ¨ç¡®è®¤æ˜¯ method ä¹‹å‰ä¸è¦æ¶ˆè´¹ static
   - æˆ–è€…å®ç° token å›é€€æœºåˆ¶

2. **æ·»åŠ  MethodDeclaration çš„ isPublic/isPrivate å±æ€§**
   - ä¿®æ”¹ AST å®šä¹‰
   - åœ¨è§£ææ—¶è®¾ç½®è¿™äº›å±æ€§

3. **å®Œå–„æ¥å£æ‰©å±•çš„é”™è¯¯å¤„ç†**
   - å¦‚æœä¸æ”¯æŒï¼Œåº”è¯¥æŠ¥é”™
   - å¦‚æœæ”¯æŒï¼Œéœ€è¦å®Œæ•´å®ç°

### ä¸­ä¼˜å…ˆçº§
1. **éªŒè¯æ•°ç»„æˆå‘˜è§£æ**
   - æ£€æŸ¥ `parseVariableDeclaration` æ˜¯å¦æ­£ç¡®å¤„ç†æ•°ç»„å¤§å°

2. **æ£€æŸ¥ static if å®ç°**
   - ç¡®è®¤è§£æå’ŒéªŒè¯é€»è¾‘

3. **ä¼˜åŒ–ä»£ç é‡å¤**
   - æå–å…¬å…±çš„æˆå‘˜è§£æé€»è¾‘

### ä½ä¼˜å…ˆçº§
1. **å®Œå–„æ³¨é‡Šå’Œæ–‡æ¡£**
   - æ·»åŠ æ›´å¤šä½¿ç”¨ç¤ºä¾‹
   - è¯´æ˜å¤æ‚é€»è¾‘çš„è®¾è®¡å†³ç­–

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ£€æŸ¥æ˜¯å¦æœ‰ä¸å¿…è¦çš„ token æ¶ˆè´¹
   - ä¼˜åŒ– lookahead æœºåˆ¶

---

## ğŸ“ æ€»ç»“

### ä¼˜ç‚¹
1. âœ… æ ¸å¿ƒåŠŸèƒ½å®ç°å®Œæ•´ï¼ˆstructã€interfaceã€methodï¼‰
2. âœ… é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„
3. âœ… ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
4. âœ… æ”¯æŒå¤§éƒ¨åˆ† vJass è¯­æ³•ç‰¹æ€§

### éœ€è¦æ”¹è¿›
1. âš ï¸ public/private static method çš„ token æ¶ˆè´¹é—®é¢˜
2. âš ï¸ MethodDeclaration ç¼ºå°‘è®¿é—®ä¿®é¥°ç¬¦å±æ€§
3. âš ï¸ æ¥å£æ‰©å±•çš„å¤„ç†ä¸å®Œæ•´
4. âš ï¸ éœ€è¦éªŒè¯é«˜çº§ç‰¹æ€§çš„å®ç°

### æ€»ä½“è¯„ä»·
è§£æå™¨å®ç°è´¨é‡è¾ƒé«˜ï¼Œæ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œä½†åœ¨ä¸€äº›è¾¹ç•Œæƒ…å†µå’Œé«˜çº§ç‰¹æ€§ä¸Šéœ€è¦è¿›ä¸€æ­¥å®Œå–„ã€‚å»ºè®®ä¼˜å…ˆä¿®å¤ token æ¶ˆè´¹é—®é¢˜å’Œæ·»åŠ è®¿é—®ä¿®é¥°ç¬¦å±æ€§ã€‚
